/*!
 * Licensed Materials - Property of IBM
 * Â© Copyright IBM Corp. 2018
 * US Government Users Restricted Rights - Use, duplication or disclosure restricted by GSA ADP Schedule Contract with IBM Corp.
 *
 * LICENSE
 * https://github.com/ibm-watson-cxa/UICaptureSDK-Modules/tree/master/AjaxListener/LICENSE
 *
 * README
 * https://github.com/ibm-watson-cxa/UICaptureSDK-Modules/tree/master/AjaxListener/README.md
 */
TLT.addModule("ajaxListener",function(b){var p={},a=false,k,l=b.utils;function j(z){var x,y,t={},u=p.filters,v,s=z.tListener.url,r=z.tListener.method,w=z.status.toString();if(!u||!u.length){return t}for(x=0,y=u.length,v=false;!v&&x<y;x+=1){t=u[x];v=true;if(t.url){v=t.url.cRegex.test(s)}if(v&&t.method){v=t.method.cRegex.test(r)}if(v&&t.status){v=t.status.cRegex.test(w)}}if(!v){t=null}return t}function g(v){var x={},t,r,w,s,u;v=v.split(/[\r\n]+/);for(t=0,r=v.length;t<r;t+=1){w=v[t].split(": ");s=w[0];u=l.rtrim(w[1]);if(s&&s.length){x[s]=u}}return x}function c(x,t){var w={type:5,customEvent:{name:"ajaxListener",data:{}}},s,r=w.customEvent.data;if(!x){return}s=document.createElement("a");s.href=x.tListener.url;r.requestURL=s.host+s.pathname;r.description="Full Ajax Monitor "+x.tListener.url;r.method=x.tListener.method;r.status=x.status;r.statusText=x.statusText||"";r.async=x.tListener.async;r.ajaxResponseTime=x.tListener.end-x.tListener.start;if(t.requestHeaders){r.requestHeaders=x.tListener.reqHeaders}if(t.requestData&&typeof x.tListener.reqData==="string"&&!x.tListener.isSystemXHR){try{r.request=JSON.parse(x.tListener.reqData)}catch(v){r.request=x.tListener.reqData}}if(t.responseHeaders){r.responseHeaders=g(x.getAllResponseHeaders())}if(t.responseData&&typeof x.responseText==="string"){try{r.response=JSON.parse(x.responseText)}catch(u){r.response=x.responseText}if(x.responseType){r.responseType=x.responseType}}b.post(w)}function i(t){var r,s={requestHeaders:false,requestData:false,responseHeaders:false,responseData:false};r=j(t);if(r){if(r.log){s=r.log}c(t,s)}}function e(s){var t,r;if(!s||!s.target){return}t=s.target;r=t.readyState;if(r===4){t.removeEventListener("readystatechange",e);t.tListener.end=Date.now();i(t)}}function d(s){var r=s.setRequestHeader;s.setRequestHeader=function(w,u){var v=this,t=v.tListener;if(w&&w.length){t.reqHeaders[w]=u}return r.apply(v,arguments)}}function o(r){var s=r.send;r.send=function(u){var v=this,t=v.tListener;if(u){t.reqData=u}t.start=Date.now();return s.apply(v,arguments)}}function f(s){var r=TLT.getServiceConfig("queue");var u=r.queues||[];for(var t=0;t<u.length;t+=1){if(u[t].endpoint&&s.indexOf(u[t].endpoint)!==-1){return true}}return false}function h(u,r,s){var t=this;if(a){t.addEventListener("readystatechange",e);t.tListener={method:u,url:r,async:(typeof s==="undefined")?true:!!s,reqHeaders:{},isSystemXHR:f(r)};d(t);o(t)}return k.apply(t,arguments)}function n(){if(XMLHttpRequest){k=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=h}}function q(r){if(r&&r.regex){r.cRegex=new RegExp(r.regex,r.flags)}}function m(s){var t,r,u,v=[];if(s&&s.filters){v=s.filters}for(t=0,r=v.length;t<r;t+=1){u=v[t];l.forEach([u.url,u.method,u.status],q)}}return{init:function(){p=b.getConfig();m(p)},destroy:function(){a=false},onevent:function(r){switch(r.type){case"load":n();a=true;break;case"unload":a=false;break;default:break}},version:"1.1.0"}});