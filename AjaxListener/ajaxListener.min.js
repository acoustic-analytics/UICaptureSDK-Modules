/*!
 * Copyright (c) 2020 Acoustic, L.P. All rights reserved.
 *
 * NOTICE: This file contains material that is confidential and proprietary to
 * Acoustic, L.P. and/or other developers. No license is granted under any intellectual or
 * industrial property rights of Acoustic, L.P. except as may be provided in an agreement with
 * Acoustic, L.P. Any unauthorized copying or distribution of content from this file is
 * prohibited.
 *
 * README
 * https://github.com/ibm-watson-cxa/UICaptureSDK-Modules/tree/master/AjaxListener/README.md
 */
TLT.addModule("ajaxListener",function(c){var l={},h=false,j,p,z,k,t=c.utils;function f(C,H,B){var E,A,F={},G=l.filters,D;if(!G||!G.length){return F}for(E=0,A=G.length,D=false;!D&&E<A;E+=1){F=G[E];D=true;if(F.url){D=F.url.cRegex.test(C)}if(D&&F.method){D=F.method.cRegex.test(H)}if(D&&F.status){D=F.status.cRegex.test(B)}}if(!D){F=null}return F}function o(E){var G={},C,A,F,B,D;E=E.split(/[\r\n]+/);for(C=0,A=E.length;C<A;C+=1){F=E[C].split(": ");B=F[0];D=t.rtrim(F[1]);if(B&&B.length){G[B]=D}}return G}function m(H,D){var G={type:5,customEvent:{name:"ajaxListener",data:{interfaceType:"XHR"}}},C,B=G.customEvent.data,A;if(!H){return}C=document.createElement("a");C.href=H.tListener.url;B.originalURL=C.host+(C.pathname[0]==="/"?"":"/")+C.pathname;B.requestURL=c.normalizeUrl?c.normalizeUrl(B.originalURL):B.originalURL;B.description="Full Ajax Monitor "+B.requestURL;B.method=H.tListener.method;B.status=H.status;B.statusText=H.statusText||"";B.async=H.tListener.async;B.ajaxResponseTime=H.tListener.end-H.tListener.start;if(D.requestHeaders){B.requestHeaders=H.tListener.reqHeaders}if(D.requestData&&typeof H.tListener.reqData==="string"&&!H.tListener.isSystemXHR){try{B.request=JSON.parse(H.tListener.reqData)}catch(F){B.request=H.tListener.reqData}}if(D.responseHeaders){B.responseHeaders=o(H.getAllResponseHeaders())}if(D.responseData){if(typeof H.responseType==="undefined"){A=H.responseText}else{if(H.responseType===""||H.responseType==="text"){A=H.response}else{if(H.responseType==="json"){B.response=H.response}else{B.response=typeof H.response}}}if(A){try{B.response=JSON.parse(A)}catch(E){B.response=A}}if(H.responseType){B.responseType=H.responseType}}c.post(G)}function q(C){var E,D={},B=C.entries(),A=B.next();while(!A.done){E=A.value;D[E[0]]=E[1];A=B.next()}return D}function g(A){return q(A)}function b(A){if(typeof A==="object"&&A.toString().indexOf("FormData")!==-1){return q(A)}return A}function r(A,E,F){var G={type:5,customEvent:{name:"ajaxListener",data:{interfaceType:"fetch"}}},D,C=G.customEvent.data,B,H;D=document.createElement("a");D.href=A.url;C.originalURL=D.host+(D.pathname[0]==="/"?"":"/")+D.pathname;C.requestURL=c.normalizeUrl?c.normalizeUrl(C.originalURL):C.originalURL;C.description="Full Ajax Monitor "+C.requestURL;C.method=A.initData.method;C.status=E.status;C.statusText=E.statusText||"";C.async=true;C.ajaxResponseTime=A.end-A.start;C.responseType=E.type;if(F.requestHeaders){if(A.initData.headers&&A.initData.headers.toString().indexOf("Headers")!==-1){C.requestHeaders=g(A.initData.headers)}else{C.requestHeaders=A.initData.headers||""}}if(F.requestData&&typeof A.body!=="undefined"&&!A.isSystemXHR){C.request=b(A.body)}if(F.responseHeaders){C.responseHeaders=g(E.headers)}if(F.responseData&&E.ok){H=E.headers.get("content-type");if(H&&H.indexOf("application/json")!==-1){E.clone().json().then(function(I){C.response=I;c.post(G)});return}if(H&&(H.indexOf("text")!==-1||H.indexOf("xml")!==-1)){E.clone().text().then(function(I){C.response=I;c.post(G)});return}C.response="Not logging unsupported response content: "+H}c.post(G)}function n(E){var C,B=E.tListener.url,F=E.tListener.method,A=E.status.toString(),D={requestHeaders:false,requestData:false,responseHeaders:false,responseData:false};C=f(B,F,A);if(C){if(C.log){D=C.log}m(E,D)}}function a(A,E){var D,C=A.url,G=A.initData.method,B=E.status.toString(),F={requestHeaders:false,requestData:false,responseHeaders:false,responseData:false};D=f(C,G,B);if(D){if(D.log){F=D.log}r(A,E,F)}}function w(B){var C,A;if(!B||!B.target){return}C=B.target;A=C.readyState;if(A===4){C.removeEventListener("readystatechange",w);C.tListener.end=Date.now();n(C)}}function s(B){var A=B.setRequestHeader;B.setRequestHeader=function(F,D){var E=this,C=E.tListener;if(F&&F.length){C.reqHeaders[F]=D}return A.apply(E,arguments)}}function y(A){var B=A.send;A.send=function(D){var E=this,C=E.tListener;if(D){C.reqData=D}C.start=Date.now();return B.apply(E,arguments)}}function u(B){var C,A,D;A=TLT.getServiceConfig("queue");D=A.queues||[];for(C=0;C<D.length;C+=1){if(D[C].endpoint&&B.indexOf(D[C].endpoint)!==-1){return true}}return false}function v(D,A,B){var C=this;if(h){C.addEventListener("readystatechange",w);C.tListener={method:D,url:A,async:(typeof B==="undefined")?true:!!B,reqHeaders:{},isSystemXHR:u(A)};s(C);y(C)}return j.apply(C,arguments)}function x(){if(XMLHttpRequest){j=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=v}}function i(){p=window.fetch;window.fetch=function(C,B){var A={},D;if(typeof C==="object"){A.initData=C;A.url=C.url;A.initData.clone().text().then(function(E){if(E.length>0){A.body=E}})}else{A.initData=B||{};A.url=C;if(B.body){A.body=B.body}}A.isSystemXHR=u(A.url);A.start=Date.now();D=p.apply(this,arguments);return D.then(function(E){A.end=Date.now();a(A,E);return E})}}function d(A){if(A&&A.regex){A.cRegex=new RegExp(A.regex,A.flags)}}function e(B){var C,A,D,E=[];if(B&&B.filters){E=B.filters}for(C=0,A=E.length;C<A;C+=1){D=E[C];t.forEach([D.url,D.method,D.status],d)}z=t.getValue(B,"xhrEnabled",true);k=t.getValue(B,"fetchEnabled",true)&&(typeof window.fetch==="function")}return{init:function(){l=c.getConfig();e(l)},destroy:function(){h=false},onevent:function(A){switch(A.type){case"load":if(z){x()}if(k){i()}h=true;break;case"unload":h=false;break;default:break}},version:"1.2.0"}});