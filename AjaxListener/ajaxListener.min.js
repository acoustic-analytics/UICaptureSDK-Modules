/*!
 * Licensed Materials - Property of IBM
 * ï¿½ Copyright IBM Corp. 2018
 * US Government Users Restricted Rights - Use, duplication or disclosure restricted by GSA ADP Schedule Contract with IBM Corp.
 *
 * LICENSE
 * https://github.com/ibm-watson-cxa/UICaptureSDK-Modules/tree/master/AjaxListener/LICENSE
 *
 * README
 * https://github.com/ibm-watson-cxa/UICaptureSDK-Modules/tree/master/AjaxListener/README.md
 */
TLT.addModule("ajaxListener",function(b){var q={},a=false,l,m=b.utils;function k(A){var y,z,u={},v=q.filters,w,t=A.tListener.url,s=A.tListener.method,x=A.status.toString();if(!v||!v.length){return u}for(y=0,z=v.length,w=false;!w&&y<z;y+=1){u=v[y];w=true;if(u.url){w=u.url.cRegex.test(t)}if(w&&u.method){w=u.method.cRegex.test(s)}if(w&&u.status){w=u.status.cRegex.test(x)}}if(!w){u=null}return u}function g(w){var y={},u,s,x,t,v;w=w.split(/[\r\n]+/);for(u=0,s=w.length;u<s;u+=1){x=w[u].split(": ");t=x[0];v=m.rtrim(x[1]);if(t&&t.length){y[t]=v}}return y}function c(y,u){var x={type:5,customEvent:{name:"ajaxListener",data:{}}},t,s=x.customEvent.data;if(!y){return}t=document.createElement("a");t.href=y.tListener.url;s.requestURL=t.host+t.pathname;s.description="Full Ajax Monitor "+y.tListener.url;s.method=y.tListener.method;s.status=y.status;s.statusText=y.statusText||"";s.async=y.tListener.async;s.ajaxResponseTime=y.tListener.end-y.tListener.start;if(u.requestHeaders){s.requestHeaders=y.tListener.reqHeaders}if(u.requestData&&typeof y.tListener.reqData==="string"&&!y.tListener.isSystemXHR){try{s.request=JSON.parse(y.tListener.reqData)}catch(w){s.request=y.tListener.reqData}}if(u.responseHeaders){s.responseHeaders=g(y.getAllResponseHeaders())}if(u.responseData&&typeof y.responseText==="string"){try{s.response=JSON.parse(y.responseText)}catch(v){s.response=y.responseText}if(y.responseType){s.responseType=y.responseType}}b.post(x)}function j(u){var s,t={requestHeaders:false,requestData:false,responseHeaders:false,responseData:false};s=k(u);if(s){if(s.log){t=s.log}c(u,t)}}function e(t){var u,s;if(!t||!t.target){return}u=t.target;s=u.readyState;if(s===4){u.removeEventListener("readystatechange",e);u.tListener.end=Date.now();j(u)}}function d(t){var s=t.setRequestHeader;t.setRequestHeader=function(x,v){var w=this,u=w.tListener;if(x&&x.length){u.reqHeaders[x]=v}return s.apply(w,arguments)}}function p(s){var t=s.send;s.send=function(v){var w=this,u=w.tListener;if(v){u.reqData=v}u.start=Date.now();return t.apply(w,arguments)}}function f(t){var s=TLT.getServiceConfig("queue");var u=s.queues||[];for(i=0;i<u.length;i+=1){endpointURL=u[i].endpoint.split("collectorPost")[0];if(t.indexOf(endpointURL)!==-1){return true}}return false}function h(v,s,t){var u=this;if(a){u.addEventListener("readystatechange",e);u.tListener={method:v,url:s,async:(typeof t==="undefined")?true:!!t,reqHeaders:{},isSystemXHR:f(s)};d(u);p(u)}return l.apply(u,arguments)}function o(){if(XMLHttpRequest){l=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=h}}function r(s){if(s&&s.regex){s.cRegex=new RegExp(s.regex,s.flags)}}function n(t){var u,s,v,w=[];if(t&&t.filters){w=t.filters}for(u=0,s=w.length;u<s;u+=1){v=w[u];m.forEach([v.url,v.method,v.status],r)}}return{init:function(){q=b.getConfig();n(q)},destroy:function(){a=false},onevent:function(s){switch(s.type){case"load":o();a=true;break;case"unload":a=false;break;default:break}},version:"1.1.0"}});