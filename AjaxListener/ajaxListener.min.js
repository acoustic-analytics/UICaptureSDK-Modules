/*!
 * Copyright (c) 2019 Acoustic, L.P. All rights reserved.
 *
 * NOTICE: This file contains material that is confidential and proprietary to
 * Acoustic, L.P. and/or other developers. No license is granted under any intellectual or
 * industrial property rights of Acoustic, L.P. except as may be provided in an agreement with
 * Acoustic, L.P. Any unauthorized copying or distribution of content from this file is
 * prohibited.
 *
 * README
 * https://github.com/ibm-watson-cxa/UICaptureSDK-Modules/tree/master/AjaxListener/README.md
 */
TLT.addModule("ajaxListener",function(b){var p={},a=false,k,l=b.utils;function j(z){var x,y,t={},u=p.filters,v,s=z.tListener.url,r=z.tListener.method,w=z.status.toString();if(!u||!u.length){return t}for(x=0,y=u.length,v=false;!v&&x<y;x+=1){t=u[x];v=true;if(t.url){v=t.url.cRegex.test(s)}if(v&&t.method){v=t.method.cRegex.test(r)}if(v&&t.status){v=t.status.cRegex.test(w)}}if(!v){t=null}return t}function g(v){var x={},t,r,w,s,u;v=v.split(/[\r\n]+/);for(t=0,r=v.length;t<r;t+=1){w=v[t].split(": ");s=w[0];u=l.rtrim(w[1]);if(s&&s.length){x[s]=u}}return x}function c(y,u){var x={type:5,customEvent:{name:"ajaxListener",data:{}}},t,s=x.customEvent.data,r;if(!y){return}t=document.createElement("a");t.href=y.tListener.url;s.originalURL=t.host+(t.pathname[0]==="/"?"":"/")+t.pathname;s.requestURL=b.normalizeUrl?b.normalizeUrl(s.originalURL):s.originalURL;s.description="Full Ajax Monitor "+s.requestURL;s.method=y.tListener.method;s.status=y.status;s.statusText=y.statusText||"";s.async=y.tListener.async;s.ajaxResponseTime=y.tListener.end-y.tListener.start;if(u.requestHeaders){s.requestHeaders=y.tListener.reqHeaders}if(u.requestData&&typeof y.tListener.reqData==="string"&&!y.tListener.isSystemXHR){try{s.request=JSON.parse(y.tListener.reqData)}catch(w){s.request=y.tListener.reqData}}if(u.responseHeaders){s.responseHeaders=g(y.getAllResponseHeaders())}if(u.responseData){if(typeof y.responseType==="undefined"){r=y.responseText}else{if(y.responseType===""||y.responseType==="text"){r=y.response}else{if(y.responseType==="json"){s.response=y.response}else{s.response=typeof y.response}}}if(r){try{s.response=JSON.parse(r)}catch(v){s.response=r}}if(y.responseType){s.responseType=y.responseType}}b.post(x)}function i(t){var r,s={requestHeaders:false,requestData:false,responseHeaders:false,responseData:false};r=j(t);if(r){if(r.log){s=r.log}c(t,s)}}function e(s){var t,r;if(!s||!s.target){return}t=s.target;r=t.readyState;if(r===4){t.removeEventListener("readystatechange",e);t.tListener.end=Date.now();i(t)}}function d(s){var r=s.setRequestHeader;s.setRequestHeader=function(w,u){var v=this,t=v.tListener;if(w&&w.length){t.reqHeaders[w]=u}return r.apply(v,arguments)}}function o(r){var s=r.send;r.send=function(u){var v=this,t=v.tListener;if(u){t.reqData=u}t.start=Date.now();return s.apply(v,arguments)}}function f(s){var t,r,u;r=TLT.getServiceConfig("queue");u=r.queues||[];for(t=0;t<u.length;t+=1){if(u[t].endpoint&&s.indexOf(u[t].endpoint)!==-1){return true}}return false}function h(u,r,s){var t=this;if(a){t.addEventListener("readystatechange",e);t.tListener={method:u,url:r,async:(typeof s==="undefined")?true:!!s,reqHeaders:{},isSystemXHR:f(r)};d(t);o(t)}return k.apply(t,arguments)}function n(){if(XMLHttpRequest){k=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=h}}function q(r){if(r&&r.regex){r.cRegex=new RegExp(r.regex,r.flags)}}function m(s){var t,r,u,v=[];if(s&&s.filters){v=s.filters}for(t=0,r=v.length;t<r;t+=1){u=v[t];l.forEach([u.url,u.method,u.status],q)}}return{init:function(){p=b.getConfig();m(p)},destroy:function(){a=false},onevent:function(r){switch(r.type){case"load":n();a=true;break;case"unload":a=false;break;default:break}},version:"1.1.4"}});